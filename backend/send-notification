import { serve } from 'https://deno.land/std@0.131.0/http/server.ts';
import { Client } from 'https://deno.land/x/sendgrid/mod.ts';

console.log('Edge Function "send-notification" démarrée');

serve(async (req) => {
  const { user_id, email, body } = await req.json();

  const sendgridClient = new Client({
    apiKey: Deno.env.get('SENDGRID_API_KEY') // Ajoutez cette clé dans les secrets
  });

  try {
    await sendgridClient.send({
      to: email,
      from: 'votre-email@example.com', // Configurez votre email d'expéditeur
      subject: 'Vos articles quotidiens - Veille',
      text: body,
      html: `<p style="font-family: Arial, sans-serif; color: #333;">${body.replace(/\n/g, '<br>')}</p>`
    });

    return new Response(
      JSON.stringify({ message: 'Notification envoyée avec succès' }),
      { status: 200, headers: { 'Content-Type': 'application/json' } }
    );
  } catch (error) {
    console.error('Erreur lors de l’envoi de la notification :', error);
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    );
  }
});